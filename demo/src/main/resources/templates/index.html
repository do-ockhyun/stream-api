<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>스트리밍 데모</title>
    <!-- marked.js 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .message-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 3px;
        }
        .error-message {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        .timestamp {
            color: #666;
            font-size: 0.8em;
        }
        .controls {
            margin: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .controls select {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .controls button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .controls button:hover {
            background-color: #0056b3;
        }
        .controls button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        /* 마크다운 스타일 */
        .markdown-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            display: none;
        }
        .markdown-content {
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .markdown-content h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .markdown-content h2 {
            color: #34495e;
            border-bottom: 1px solid #bdc3c7;
            padding-bottom: 5px;
        }
        .markdown-content h3 {
            color: #7f8c8d;
        }
        .markdown-content code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .markdown-content pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .markdown-content blockquote {
            border-left: 4px solid #3498db;
            padding-left: 15px;
            color: #7f8c8d;
            font-style: italic;
        }
        .markdown-content ul, .markdown-content ol {
            padding-left: 20px;
        }
        .markdown-content li {
            margin: 5px 0;
        }
        .markdown-content strong {
            color: #2c3e50;
        }
        .markdown-content em {
            color: #e74c3c;
        }
        .markdown-content hr {
            border: none;
            border-top: 2px solid #ecf0f1;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1 th:text="${title}"></h1>
    
    <div class="controls">
        <h3>스트리밍 타입 선택</h3>
        <select id="streamType">
            <option value="">타입을 선택하세요</option>
            <option value="sample">샘플 텍스트</option>
            <option value="numbers">숫자</option>
            <option value="markdown">마크다운</option>
        </select>
        <button id="startBtn" onclick="startStreaming()">스트리밍 시작</button>
        <button id="stopBtn" onclick="stopStreaming()" disabled>스트리밍 중지</button>
        <div id="status" class="status disconnected">연결되지 않음</div>
    </div>

    <div class="message-container" id="messageContainer">
        <h2>수신된 메시지</h2>
        <div id="messages">
            <!-- 메시지가 여기에 동적으로 추가됩니다 -->
        </div>
    </div>

    <div class="markdown-container" id="markdownContainer">
        <h2>마크다운 렌더링</h2>
        <div id="markdownContent" class="markdown-content">
            <!-- 마크다운이 여기에 렌더링됩니다 -->
        </div>
    </div>

    <script>
        let eventSource = null;
        const messagesDiv = document.getElementById('messages');
        const streamTypeSelect = document.getElementById('streamType');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');
        const messageContainer = document.getElementById('messageContainer');
        const markdownContainer = document.getElementById('markdownContainer');
        const markdownContent = document.getElementById('markdownContent');
        
        // 마크다운 청크를 누적할 변수
        let markdownChunks = [];
        let isMarkdownMode = false;

        function startStreaming() {
            const selectedType = streamTypeSelect.value;
            
            // if (!selectedType) {
            //     alert('스트리밍 타입을 선택해주세요.');
            //     return;
            // }

            // 기존 연결이 있다면 닫기
            if (eventSource) {
                eventSource.close();
            }

            // UI 상태 업데이트
            startBtn.disabled = true;
            stopBtn.disabled = false;
            streamTypeSelect.disabled = true;
            statusDiv.textContent = '연결 중...';
            statusDiv.className = 'status disconnected';

            // 마크다운 모드 확인
            isMarkdownMode = selectedType === 'markdown';
            
            // 컨테이너 표시/숨김 설정
            if (isMarkdownMode) {
                messageContainer.style.display = 'none';
                markdownContainer.style.display = 'block';
                markdownChunks = []; // 마크다운 청크 초기화
                markdownContent.innerHTML = '';
            } else {
                messageContainer.style.display = 'block';
                markdownContainer.style.display = 'none';
                messagesDiv.innerHTML = '';
            }

            // API 엔드포인트 결정
            let apiEndpoint;
            if (isMarkdownMode) {
                apiEndpoint = '/api/md';
            } else {
                apiEndpoint = `/api/messages?type=${selectedType}`;
            }

            // SSE 연결 설정
            eventSource = new EventSource(apiEndpoint);

            eventSource.onopen = function(event) {
                statusDiv.textContent = '연결됨 - 스트리밍 중...';
                statusDiv.className = 'status connected';
            };

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    // 에러 메시지 처리
                    if (data.error) {
                        const errorElement = document.createElement('div');
                        errorElement.className = 'message error-message';
                        errorElement.innerHTML = `
                            <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                            <strong>에러:</strong> 
                            <span>${data.error}</span>
                        `;
                        messagesDiv.insertBefore(errorElement, messagesDiv.firstChild);
                        return;
                    }
                    
                    if (isMarkdownMode) {
                        // 마크다운 모드 처리
                        handleMarkdownChunk(data);
                    } else {
                        // 일반 메시지 처리
                        handleRegularMessage(data);
                    }
                    
                } catch (error) {
                    console.error('메시지 파싱 에러:', error);
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message error-message';
                    errorElement.innerHTML = `
                        <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                        <strong>파싱 에러:</strong> 
                        <span>${event.data}</span>
                    `;
                    messagesDiv.insertBefore(errorElement, messagesDiv.firstChild);
                }
            };

            eventSource.onerror = function(error) {
                console.error('SSE 에러:', error);
                statusDiv.textContent = '연결 오류';
                statusDiv.className = 'status disconnected';
                stopStreaming();
            };

            eventSource.onclose = function(event) {
                console.log('SSE 연결 종료');
                if (isMarkdownMode) {
                    // 마크다운 모드에서 연결 종료 시 최종 정리
                    const finalMarkdown = markdownChunks.join('').trim();
                    if (finalMarkdown) {
                        try {
                            const htmlContent = marked.parse(finalMarkdown);
                            markdownContent.innerHTML = htmlContent;
                        } catch (error) {
                            console.error('최종 마크다운 렌더링 에러:', error);
                        }
                    }
                }
                stopStreaming();
            };
        }

        function handleMarkdownChunk(data) {
            // undefined 값 처리
            let chunk = data.chunk !== undefined ? data.chunk : '청크 없음';
            const timestamp = data.timestamp !== undefined ? data.timestamp : new Date().toLocaleTimeString();
            
            // 디버깅용 로그
            console.log('받은 청크:', chunk);
            console.log('청크 타입:', typeof chunk);
            
            // 개행 문자 처리
            if (typeof chunk === 'string') {
                // 특별한 마커를 개행으로 변환
                chunk = chunk.replace(/___NEWLINE___/g, '\n');
                // <br> 태그를 개행으로 변환 (이전 버전 호환성)
                chunk = chunk.replace(/<br>/g, '\n');
                // JSON에서 이스케이프된 개행을 실제 개행으로 변환
                chunk = chunk.replace(/\\n/g, '\n');
                // HTML 엔티티를 원래 문자로 변환
                chunk = chunk.replace(/&quot;/g, '"').replace(/\\\\/g, '\\');
                
                // 디버깅: 개행 문자 확인
                console.log('개행 문자 포함 여부:', chunk.includes('\n'));
                console.log('청크 길이:', chunk.length);
                console.log('청크 내용:', JSON.stringify(chunk));
            }
            
            console.log('처리된 청크:', chunk);
            
            // 빈 청크나 의미 없는 청크는 건너뛰기 (단, 개행만 있는 경우는 허용)
            if ((chunk.trim() === '' && !chunk.includes('\n')) || chunk === '청크 없음') {
                console.log('빈 청크 건너뛰기');
                return;
            }
            
            // 마크다운 청크 누적
            markdownChunks.push(chunk);
            
            // 전체 마크다운 텍스트 구성 (개행 보존)
            const fullMarkdown = markdownChunks.join('');
            
            console.log('전체 마크다운:', fullMarkdown);
            
            // 마크다운을 HTML로 렌더링
            try {
                const htmlContent = marked.parse(fullMarkdown);
                markdownContent.innerHTML = htmlContent;
                
                // 스크롤을 맨 아래로 이동
                markdownContent.scrollTop = markdownContent.scrollHeight;
            } catch (error) {
                console.error('마크다운 렌더링 에러:', error);
                markdownContent.innerHTML = `<p>마크다운 렌더링 에러: ${error.message}</p>`;
            }
        }

        function handleRegularMessage(data) {
            // 정상 메시지 처리
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            // undefined 값 처리
            const id = data.id !== undefined ? data.id : 'N/A';
            const message = data.message !== undefined ? data.message : '메시지 없음';
            const timestamp = data.timestamp !== undefined ? data.timestamp : new Date().toLocaleTimeString();
            
            messageElement.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <strong>ID ${id}:</strong> 
                <span>${message}</span>
            `;
            
            // 메시지를 컨테이너의 맨 위에 추가
            messagesDiv.insertBefore(messageElement, messagesDiv.firstChild);
        }

        function stopStreaming() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            // UI 상태 업데이트
            startBtn.disabled = false;
            stopBtn.disabled = true;
            streamTypeSelect.disabled = false;
            statusDiv.textContent = '연결되지 않음';
            statusDiv.className = 'status disconnected';
            
            // 컨테이너 초기화
            messageContainer.style.display = 'block';
            markdownContainer.style.display = 'none';
        }

        // 페이지 로드 시 초기 상태 설정
        document.addEventListener('DOMContentLoaded', function() {
            statusDiv.textContent = '연결되지 않음';
            statusDiv.className = 'status disconnected';
        });
    </script>
</body>
</html>
