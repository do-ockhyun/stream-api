<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>스트리밍 데모</title>
    <style>
        .message-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 3px;
        }
        .error-message {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        .timestamp {
            color: #666;
            font-size: 0.8em;
        }
        .controls {
            margin: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .controls select {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .controls button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .controls button:hover {
            background-color: #0056b3;
        }
        .controls button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1 th:text="${title}"></h1>
    
    <div class="controls">
        <h3>스트리밍 타입 선택</h3>
        <select id="streamType">
            <option value="">타입을 선택하세요</option>
            <option value="sample">샘플 텍스트</option>
            <option value="numbers">숫자</option>
        </select>
        <button id="startBtn" onclick="startStreaming()">스트리밍 시작</button>
        <button id="stopBtn" onclick="stopStreaming()" disabled>스트리밍 중지</button>
        <div id="status" class="status disconnected">연결되지 않음</div>
    </div>

    <div class="message-container">
        <h2>수신된 메시지</h2>
        <div id="messages">
            <!-- 메시지가 여기에 동적으로 추가됩니다 -->
        </div>
    </div>

    <script>
        let eventSource = null;
        const messagesDiv = document.getElementById('messages');
        const streamTypeSelect = document.getElementById('streamType');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');

        function startStreaming() {
            const selectedType = streamTypeSelect.value;
            
            // if (!selectedType) {
            //     alert('스트리밍 타입을 선택해주세요.');
            //     return;
            // }

            // 기존 연결이 있다면 닫기
            if (eventSource) {
                eventSource.close();
            }

            // UI 상태 업데이트
            startBtn.disabled = true;
            stopBtn.disabled = false;
            streamTypeSelect.disabled = true;
            statusDiv.textContent = '연결 중...';
            statusDiv.className = 'status disconnected';

            // 메시지 컨테이너 초기화
            messagesDiv.innerHTML = '';

            // SSE 연결 설정
            eventSource = new EventSource(`/api/messages?type=${selectedType}`);

            eventSource.onopen = function(event) {
                statusDiv.textContent = '연결됨 - 스트리밍 중...';
                statusDiv.className = 'status connected';
            };

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    // 에러 메시지 처리
                    if (data.error) {
                        const errorElement = document.createElement('div');
                        errorElement.className = 'message error-message';
                        errorElement.innerHTML = `
                            <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                            <strong>에러:</strong> 
                            <span>${data.error}</span>
                        `;
                        messagesDiv.insertBefore(errorElement, messagesDiv.firstChild);
                        return;
                    }
                    
                    // 정상 메시지 처리
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message';
                    
                    // undefined 값 처리
                    const id = data.id !== undefined ? data.id : 'N/A';
                    const message = data.message !== undefined ? data.message : '메시지 없음';
                    const timestamp = data.timestamp !== undefined ? data.timestamp : new Date().toLocaleTimeString();
                    
                    messageElement.innerHTML = `
                        <span class="timestamp">[${timestamp}]</span>
                        <strong>ID ${id}:</strong> 
                        <span>${message}</span>
                    `;
                    
                    // 메시지를 컨테이너의 맨 위에 추가
                    messagesDiv.insertBefore(messageElement, messagesDiv.firstChild);
                    
                } catch (error) {
                    console.error('메시지 파싱 에러:', error);
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message error-message';
                    errorElement.innerHTML = `
                        <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                        <strong>파싱 에러:</strong> 
                        <span>${event.data}</span>
                    `;
                    messagesDiv.insertBefore(errorElement, messagesDiv.firstChild);
                }
            };

            eventSource.onerror = function(error) {
                console.error('SSE 에러:', error);
                statusDiv.textContent = '연결 오류';
                statusDiv.className = 'status disconnected';
                stopStreaming();
            };
        }

        function stopStreaming() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            // UI 상태 업데이트
            startBtn.disabled = false;
            stopBtn.disabled = true;
            streamTypeSelect.disabled = false;
            statusDiv.textContent = '연결되지 않음';
            statusDiv.className = 'status disconnected';
        }

        // 페이지 로드 시 초기 상태 설정
        document.addEventListener('DOMContentLoaded', function() {
            statusDiv.textContent = '연결되지 않음';
            statusDiv.className = 'status disconnected';
        });
    </script>
</body>
</html>
